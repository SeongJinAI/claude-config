#!/bin/bash

# Pre-commit í›…
# ì»¤ë°‹ ì „ ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬ë¥¼ ìˆ˜í–‰í•©ë‹ˆë‹¤.

set -e

echo "ğŸ” Pre-commit ê²€ì‚¬ ì‹œì‘..."

# í”„ë¡œì íŠ¸ íƒ€ì… ê°ì§€
detect_project_type() {
    if [ -f "build.gradle" ] || [ -f "build.gradle.kts" ]; then
        echo "spring-boot"
    elif [ -f "requirements.txt" ] || [ -f "pyproject.toml" ]; then
        echo "fastapi"
    elif [ -f "package.json" ]; then
        if grep -q "next" package.json 2>/dev/null; then
            echo "nextjs"
        else
            echo "node"
        fi
    else
        echo "unknown"
    fi
}

PROJECT_TYPE=$(detect_project_type)
echo "ğŸ“¦ í”„ë¡œì íŠ¸ íƒ€ì…: $PROJECT_TYPE"

# Spring Boot ê²€ì‚¬
run_spring_boot_checks() {
    echo "â˜• Spring Boot ê²€ì‚¬ ì‹¤í–‰..."

    # ì»´íŒŒì¼ ê²€ì‚¬
    if ./gradlew compileJava --quiet 2>/dev/null; then
        echo "   âœ“ ì»´íŒŒì¼ ì„±ê³µ"
    else
        echo "   âœ— ì»´íŒŒì¼ ì‹¤íŒ¨"
        exit 1
    fi

    # ìŠ¤í…Œì´ì§•ëœ Java íŒŒì¼ì´ ìˆìœ¼ë©´ spotless ê²€ì‚¬ (ì„¤ì •ë˜ì–´ ìˆëŠ” ê²½ìš°)
    if git diff --cached --name-only | grep -q "\.java$"; then
        if ./gradlew spotlessCheck --quiet 2>/dev/null; then
            echo "   âœ“ ì½”ë“œ ìŠ¤íƒ€ì¼ ê²€ì‚¬ í†µê³¼"
        fi
    fi
}

# FastAPI/Python ê²€ì‚¬
run_fastapi_checks() {
    echo "ğŸ Python ê²€ì‚¬ ì‹¤í–‰..."

    # ìŠ¤í…Œì´ì§•ëœ Python íŒŒì¼
    STAGED_PY=$(git diff --cached --name-only | grep "\.py$" || true)

    if [ -n "$STAGED_PY" ]; then
        # ruff ë¦°íŠ¸ (ì„¤ì¹˜ë˜ì–´ ìˆëŠ” ê²½ìš°)
        if command -v ruff &> /dev/null; then
            echo "$STAGED_PY" | xargs ruff check --quiet && echo "   âœ“ Ruff ê²€ì‚¬ í†µê³¼"
        fi

        # mypy íƒ€ì… ê²€ì‚¬ (ì„¤ì¹˜ë˜ì–´ ìˆëŠ” ê²½ìš°)
        if command -v mypy &> /dev/null; then
            echo "$STAGED_PY" | xargs mypy --ignore-missing-imports --quiet 2>/dev/null && echo "   âœ“ íƒ€ì… ê²€ì‚¬ í†µê³¼"
        fi
    fi
}

# Next.js/Node ê²€ì‚¬
run_nextjs_checks() {
    echo "âš›ï¸  Next.js ê²€ì‚¬ ì‹¤í–‰..."

    # ìŠ¤í…Œì´ì§•ëœ TS/TSX/JS íŒŒì¼
    STAGED_JS=$(git diff --cached --name-only | grep -E "\.(ts|tsx|js|jsx)$" || true)

    if [ -n "$STAGED_JS" ]; then
        # ESLint ê²€ì‚¬
        if [ -f "node_modules/.bin/eslint" ]; then
            echo "$STAGED_JS" | xargs npx eslint --quiet && echo "   âœ“ ESLint ê²€ì‚¬ í†µê³¼"
        fi

        # TypeScript íƒ€ì… ê²€ì‚¬
        if [ -f "tsconfig.json" ]; then
            npx tsc --noEmit --quiet 2>/dev/null && echo "   âœ“ TypeScript ê²€ì‚¬ í†µê³¼"
        fi
    fi
}

# ê³µí†µ ê²€ì‚¬: ë¯¼ê° ì •ë³´ í™•ì¸
check_sensitive_files() {
    echo "ğŸ” ë¯¼ê° ì •ë³´ ê²€ì‚¬..."

    SENSITIVE_PATTERNS=(
        "\.env$"
        "\.env\.local$"
        "\.env\.production$"
        "credentials\.json$"
        "secrets\.yaml$"
        "\.pem$"
        "\.key$"
    )

    STAGED_FILES=$(git diff --cached --name-only)

    for pattern in "${SENSITIVE_PATTERNS[@]}"; do
        if echo "$STAGED_FILES" | grep -qE "$pattern"; then
            echo "   âš ï¸  ê²½ê³ : ë¯¼ê° íŒŒì¼ì´ ìŠ¤í…Œì´ì§•ë˜ì–´ ìˆìŠµë‹ˆë‹¤: $pattern"
            echo "   ê³„ì†í•˜ë ¤ë©´ --no-verify ì˜µì…˜ì„ ì‚¬ìš©í•˜ì„¸ìš”."
            exit 1
        fi
    done

    echo "   âœ“ ë¯¼ê° ì •ë³´ ê²€ì‚¬ í†µê³¼"
}

# ê³µí†µ ê²€ì‚¬: í° íŒŒì¼ í™•ì¸
check_large_files() {
    echo "ğŸ“ íŒŒì¼ í¬ê¸° ê²€ì‚¬..."

    MAX_SIZE=5242880  # 5MB

    LARGE_FILES=$(git diff --cached --name-only | while read file; do
        if [ -f "$file" ]; then
            size=$(stat -f%z "$file" 2>/dev/null || stat -c%s "$file" 2>/dev/null || echo 0)
            if [ "$size" -gt "$MAX_SIZE" ]; then
                echo "$file ($(($size / 1024 / 1024))MB)"
            fi
        fi
    done)

    if [ -n "$LARGE_FILES" ]; then
        echo "   âš ï¸  ê²½ê³ : 5MB ì´ˆê³¼ íŒŒì¼ì´ ìˆìŠµë‹ˆë‹¤:"
        echo "$LARGE_FILES"
        exit 1
    fi

    echo "   âœ“ íŒŒì¼ í¬ê¸° ê²€ì‚¬ í†µê³¼"
}

# ê²€ì‚¬ ì‹¤í–‰
check_sensitive_files
check_large_files

case $PROJECT_TYPE in
    spring-boot)
        run_spring_boot_checks
        ;;
    fastapi)
        run_fastapi_checks
        ;;
    nextjs|node)
        run_nextjs_checks
        ;;
    *)
        echo "âš ï¸  ì•Œ ìˆ˜ ì—†ëŠ” í”„ë¡œì íŠ¸ íƒ€ì…, ê¸°ë³¸ ê²€ì‚¬ë§Œ ìˆ˜í–‰"
        ;;
esac

echo ""
echo "âœ… Pre-commit ê²€ì‚¬ ì™„ë£Œ!"
