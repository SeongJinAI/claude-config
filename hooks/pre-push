#!/bin/bash

# Pre-push í›…
# í‘¸ì‹œ ì „ ë¹Œë“œ ë° í…ŒìŠ¤íŠ¸ë¥¼ ìˆ˜í–‰í•©ë‹ˆë‹¤.

set -e

echo "ğŸš€ Pre-push ê²€ì‚¬ ì‹œì‘..."

# í˜„ì¬ ë¸Œëœì¹˜
CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)
echo "ğŸ“Œ í˜„ì¬ ë¸Œëœì¹˜: $CURRENT_BRANCH"

# í”„ë¡œì íŠ¸ íƒ€ì… ê°ì§€
detect_project_type() {
    if [ -f "build.gradle" ] || [ -f "build.gradle.kts" ]; then
        echo "spring-boot"
    elif [ -f "requirements.txt" ] || [ -f "pyproject.toml" ]; then
        echo "fastapi"
    elif [ -f "package.json" ]; then
        if grep -q "next" package.json 2>/dev/null; then
            echo "nextjs"
        else
            echo "node"
        fi
    else
        echo "unknown"
    fi
}

PROJECT_TYPE=$(detect_project_type)
echo "ğŸ“¦ í”„ë¡œì íŠ¸ íƒ€ì…: $PROJECT_TYPE"

# ë³´í˜¸ëœ ë¸Œëœì¹˜ í™•ì¸
check_protected_branch() {
    PROTECTED_BRANCHES=("main" "master" "production")

    for branch in "${PROTECTED_BRANCHES[@]}"; do
        if [ "$CURRENT_BRANCH" == "$branch" ]; then
            echo "âš ï¸  ê²½ê³ : ë³´í˜¸ëœ ë¸Œëœì¹˜($branch)ì— ì§ì ‘ í‘¸ì‹œí•˜ë ¤ê³  í•©ë‹ˆë‹¤."
            echo "   PRì„ í†µí•´ ë¨¸ì§€í•˜ëŠ” ê²ƒì„ ê¶Œì¥í•©ë‹ˆë‹¤."
            read -p "   ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (y/N) " -n 1 -r
            echo
            if [[ ! $REPLY =~ ^[Yy]$ ]]; then
                echo "âŒ í‘¸ì‹œê°€ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤."
                exit 1
            fi
        fi
    done
}

# Spring Boot ê²€ì‚¬
run_spring_boot_checks() {
    echo "â˜• Spring Boot ë¹Œë“œ ë° í…ŒìŠ¤íŠ¸..."

    # ë¹Œë“œ
    echo "   ğŸ“¦ ë¹Œë“œ ì¤‘..."
    if ./gradlew build -x test --quiet; then
        echo "   âœ“ ë¹Œë“œ ì„±ê³µ"
    else
        echo "   âœ— ë¹Œë“œ ì‹¤íŒ¨"
        exit 1
    fi

    # í…ŒìŠ¤íŠ¸ (main/master ë¸Œëœì¹˜ë¡œ í‘¸ì‹œí•  ë•Œë§Œ)
    if [[ "$CURRENT_BRANCH" == "main" || "$CURRENT_BRANCH" == "master" || "$CURRENT_BRANCH" == "dev" ]]; then
        echo "   ğŸ§ª í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì¤‘..."
        if ./gradlew test --quiet; then
            echo "   âœ“ í…ŒìŠ¤íŠ¸ í†µê³¼"
        else
            echo "   âœ— í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨"
            exit 1
        fi
    fi
}

# FastAPI ê²€ì‚¬
run_fastapi_checks() {
    echo "ğŸ FastAPI í…ŒìŠ¤íŠ¸..."

    # pytest ì‹¤í–‰
    if command -v pytest &> /dev/null; then
        echo "   ğŸ§ª í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì¤‘..."
        if pytest --quiet 2>/dev/null; then
            echo "   âœ“ í…ŒìŠ¤íŠ¸ í†µê³¼"
        else
            echo "   âœ— í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨"
            exit 1
        fi
    else
        echo "   âš ï¸  pytestê°€ ì„¤ì¹˜ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤."
    fi
}

# Next.js ê²€ì‚¬
run_nextjs_checks() {
    echo "âš›ï¸  Next.js ë¹Œë“œ..."

    # ë¹Œë“œ ê²€ì‚¬
    echo "   ğŸ“¦ ë¹Œë“œ ì¤‘..."
    if npm run build --quiet 2>/dev/null; then
        echo "   âœ“ ë¹Œë“œ ì„±ê³µ"
    else
        echo "   âœ— ë¹Œë“œ ì‹¤íŒ¨"
        exit 1
    fi

    # í…ŒìŠ¤íŠ¸ (test ìŠ¤í¬ë¦½íŠ¸ê°€ ìˆëŠ” ê²½ìš°)
    if grep -q '"test"' package.json; then
        echo "   ğŸ§ª í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì¤‘..."
        if npm test --quiet 2>/dev/null; then
            echo "   âœ“ í…ŒìŠ¤íŠ¸ í†µê³¼"
        fi
    fi
}

# ë³´í˜¸ëœ ë¸Œëœì¹˜ í™•ì¸
check_protected_branch

# í”„ë¡œì íŠ¸ íƒ€ì…ë³„ ê²€ì‚¬ ì‹¤í–‰
case $PROJECT_TYPE in
    spring-boot)
        run_spring_boot_checks
        ;;
    fastapi)
        run_fastapi_checks
        ;;
    nextjs|node)
        run_nextjs_checks
        ;;
    *)
        echo "âš ï¸  ì•Œ ìˆ˜ ì—†ëŠ” í”„ë¡œì íŠ¸ íƒ€ì…, ê²€ì‚¬ ê±´ë„ˆëœ€"
        ;;
esac

echo ""
echo "âœ… Pre-push ê²€ì‚¬ ì™„ë£Œ! í‘¸ì‹œë¥¼ ì§„í–‰í•©ë‹ˆë‹¤."
